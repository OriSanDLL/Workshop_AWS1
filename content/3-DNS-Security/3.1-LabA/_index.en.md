---
title : "Lab A: Gaining visibility into VPC activity"
date :  "`r Sys.Date()`" 
weight : 1
chapter : false
pre : " <b> 3.1 </b> "
---
### Overview:
1. **Receive third-party notifications** about suspicious activities coming from outside into your personal infrastructure.
2. **First task**: Enable **DNS query logging** to capture DNS query requests.
3. Objective: **Identify the source and destination** of the queries to investigate suspicious activities.
    
This will assist in monitoring and handling security incidents related to DNS queries.

### Starting Point:
Let's consider how we can capture and log DNS queries in our VPC, and then how you can analyze those logs to look for suspicious activities. Some fields that will be useful for creating your own queries are:
   - **query_name:** the domain name being queried (e.g., test.example.com.)
   - **srcids.instance:** the EC2 instance ID that made the query
   - **rcode:** the response code generated by the Route 53 resolver to respond to the DNS query
   - **answers.0.Rdata:** the response of the query (IPv4 or IPv6)
    
Sample queries can be [found here](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html).

### Pre-deployed Infrastructure
There is a pre-configured Amazon Cloudwatch Log Group (`"Route53Resolver"`) that we can use when configuring DNS query logging. Make sure to check if your personal dashboard shows that you are working in the correct region for the workshop.
    
### Services Used
   - Amazon Route 53 Resolver DNS Query Logging - [Documentation](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-query-logs.html)
   - Amazon CloudWatch Log Insights - [Documentation](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html)
### Success Criteria
   - You have successfully enabled DNS query logging for the **LabVpc** VPC.
        
   - You have identified the DNS name of an unknown website that you suspect is problematic.
    
Ensure that all tasks identified on the [Lab A CloudWatch Dashboard](https://console.aws.amazon.com/cloudwatch/home?#dashboards:name=LabA) have been completed.

### Tips
**To enable query logging**
   - Query logs for the VPC can be found in the [Amazon Route 53 Resolver](https://console.aws.amazon.com/route53resolver/home) section of the AWS console.
            + Make sure you have switched to the region where your workshop is running.
**To analyze query logs**
   - After you have logged the queries, you can start running queries against the data using [CloudWatch Log Insights](https://console.aws.amazon.com/cloudwatch/home#logsV2:logs-insights).
   - Some fields that will be useful for creating your own queries are:
      + **query_name:** the domain name being queried (e.g., "test.example.com.")
      + **srcids.instance:** the EC2 instance ID that made the query
      + **rcode:** the response code generated by the Route 53 resolver to respond to the DNS query
      + **answers.0.Rdata:** the response of the query (IPv4 or IPv6)
   - Example queries can be found [here](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html)
   - If you are having trouble, we have created some pre-saved queries in the workshop - you can find them on the Log Insights page, on the right side, below the "Discovered Fields" button.
{{% notice note %}}
Note that it may take a few minutes from enabling query logging to seeing results in CloudWatch Logs Insights - please be patient!
{{% /notice %}}   
        
**Lab A Architecture**
![A](/images/structure/A1.png)

[**Lab A Guide**](3.1.1-WA/_index.en.md)